# Bug Report: Priority 3 Database Optimizations

**Date:** 2025-12-27
**Status:** PARTIALLY RESOLVED
**Priority:** Low
**Category:** Database Optimisation

---

## Summary

Applied Priority 3 database optimizations including RLS policy consolidation on actions table, documented unified_meetings normalisation plan, and verified history tables have no data requiring archiving.

---

## Completed Work

### 1. RLS Policy Consolidation on actions âœ…

**Before:** 15 redundant policies
**After:** 5 clean policies

| Old Policy | Action |
|------------|--------|
| Allow all users to update actions | DROPPED |
| Allow anon delete/insert/read/update actions | DROPPED |
| Allow anonymous read actions | DROPPED |
| Allow authenticated delete/insert/read/update actions | DROPPED |
| Service role full access actions | DROPPED |
| actions_delete_admin_NEW | DROPPED |
| actions_insert_authenticated_NEW | DROPPED |
| actions_read_authenticated_NEW | DROPPED |
| actions_write_own_NEW | DROPPED |

**New Policies:**
| Policy | Command | Role | Description |
|--------|---------|------|-------------|
| service_role_full_access | ALL | service_role | Full access for backend |
| authenticated_read | SELECT | authenticated | All users can read |
| authenticated_insert | INSERT | authenticated | All users can create |
| authenticated_update | UPDATE | authenticated | All users can update |
| authenticated_delete | DELETE | authenticated | All users can delete |

**Benefits:**
- Reduced policy count by 67% (15 â†’ 5)
- Removed redundant anon policies
- Removed public role policy (security improvement)
- Clearer policy naming convention

### 2. unified_meetings Normalisation ðŸ“‹

**Status:** PLANNED (Not Executed)

Created detailed normalisation plan to split 54-column table into 8 logical tables:
- unified_meetings (16 core columns)
- meeting_content (5 columns)
- meeting_ai_analysis (6 columns)
- meeting_sentiment (4 columns)
- meeting_effectiveness (7 columns)
- meeting_insights (6 columns)
- meeting_sync (5 columns)
- meeting_classification (5 columns)

**Why Not Executed:**
- High risk of breaking production
- Requires extensive application code updates
- Needs thorough testing environment
- Should be done during maintenance window

**Documentation:** `docs/migrations/20251227_unified_meetings_normalisation_plan.md`

### 3. History Table Archiving âž–

**Status:** NOT NEEDED

| Table | Rows | Date Range | Records > 1yr |
|-------|------|------------|---------------|
| aged_accounts_history | 427 | Dec 2025 | 0 |
| client_health_history | 540 | Dec 2025 | 0 |
| aging_compliance_history | 6 | Dec 2025 | 0 |
| skipped_outlook_events | 203 | Dec 2025 | 0 |

All history data is recent (December 2025). No archiving required at this time.

---

## Scripts Created

| Script | Purpose |
|--------|---------|
| `analyse-unified-meetings.mjs` | Analyse table structure for normalisation |
| `consolidate-actions-rls.mjs` | Consolidate RLS policies from 15 to 5 |

---

## Database State Summary

### After All Optimizations (Priority 1-3)

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Tables | 89 | 87 | -2 |
| RLS Policies (actions) | 15 | 5 | -10 |
| client_uuid Coverage | 0% | 92% | +92% |
| Tables without RLS | 5 | 3 | -2 |
| Deprecated tables | 0 | 3 | +3 |

### Deprecated Tables
1. `test_meetings` - DROPPED
2. `aging_accounts_history` - DROPPED (empty duplicate)
3. `client_name_aliases` - DEPRECATED (use client_aliases_unified)
4. `nps_clients` - DEPRECATED (use clients)
5. `client_meetings` - DEPRECATED (use unified_meetings)

---

## Future Work

### When to Execute unified_meetings Normalisation
- During planned maintenance window
- After thorough testing in staging environment
- With full rollback plan ready
- When application code is updated to use new table structure

### Archiving Strategy
- Implement automatic archiving when history tables exceed 10,000 rows
- Consider partitioning for time-series data
- Set up retention policy (e.g., keep 2 years, archive older)

---

*Report generated by Claude Code on 2025-12-27*
