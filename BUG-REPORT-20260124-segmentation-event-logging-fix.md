# Bug Report: Segmentation Event Logging Failing

**Date:** 2026-01-24
**Severity:** High (Functionality Broken)
**Status:** Resolved

## Summary

When trying to log events in the Segmentation Event Progress modal, the operation failed with the error "Failed to log events".

## Root Cause

The `useEvents` hook was attempting to insert data into non-existent columns in the `segmentation_events` database table:

1. **`attendees`** - Column does not exist
2. **`location`** - Column does not exist
3. **`meeting_id`** - Wrong column name (should be `linked_meeting_id`)
4. **`effectiveness_score`** - Column does not exist
5. **`event_month` / `event_year`** - Generated columns (cannot be inserted directly)

### Database Error
```
code: 'PGRST204'
message: "Could not find the 'attendees' column of 'segmentation_events' in the schema cache"
```

## Actual Database Schema

The `segmentation_events` table has these columns:
- id, client_name, client_segmentation_id, event_type_id
- event_date, event_month (generated), event_year (generated)
- completed, completed_date, completed_by
- notes, meeting_link, linked_meeting_id
- created_at, updated_at, created_by
- expected_count, period, edit_history
- client_id, scheduled_date, source

## Resolution

### Files Modified

1. **`src/hooks/useEvents.ts`**
   - Updated `Event` interface to match actual database schema
   - Updated `NewEvent` interface to remove non-existent fields
   - Updated `UpdateEvent` interface to remove non-existent fields
   - Fixed `createEvent()` to not include `attendees`, `location`, `event_month`, `event_year`
   - Fixed `createEvent()` to use `linked_meeting_id` instead of `meeting_id`
   - Updated `markEventComplete()` to remove unused `effectivenessScore` parameter
   - Updated `fetchFreshData()` data mapping to match actual columns

2. **`src/components/EventDetailModal.tsx`**
   - Removed sections displaying non-existent fields (location, attendees, effectiveness_score)
   - Removed unused icon imports (MapPin, Star, Users)

3. **`src/components/ScheduleEventModal.tsx`**
   - Removed `attendees` and `location` from NewEvent creation
   - Moved attendees/location data into the notes field for preservation

4. **`src/app/(dashboard)/segmentation/page.tsx`**
   - Updated `handleMarkComplete()` to match new function signature (removed effectivenessScore)

## Testing Performed

- [x] Database insert test passes with correct columns
- [x] Event month/year correctly generated by database (not inserted)
- [x] Build passes without TypeScript errors
- [x] Test event created and cleaned up successfully

## Migration Notes

If attendees, location, or effectiveness_score data is needed in the future, the database schema would need to be updated with a migration to add these columns.

## Related Files

- Hook: `src/hooks/useEvents.ts`
- Modal: `src/components/compliance/QuickEventCaptureModal.tsx`
- Detail Modal: `src/components/EventDetailModal.tsx`
- Schedule Modal: `src/components/ScheduleEventModal.tsx`
- Page: `src/app/(dashboard)/segmentation/page.tsx`
