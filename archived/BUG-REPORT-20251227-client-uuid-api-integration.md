# Bug Report: Client UUID API Integration

**Date:** 2025-12-27
**Status:** RESOLVED
**Priority:** Medium
**Category:** Database Optimisation / API Enhancement

---

## Summary

Updated all API routes to use `client_uuid` for database queries instead of `client_name` string matching. This improves query performance, ensures data consistency through the unified client system, and reduces reliance on case-insensitive string matching.

---

## Changes Applied

### 1. comments/by-client/route.ts ✅

**Before:**
```typescript
.eq('client_name', client_name)
```

**After:**
```typescript
import { resolveClientUUID } from '@/lib/client-resolver'
// ... resolves client_name to UUID
.eq('client_uuid', clientUUID)
```

**Benefits:**
- Uses indexed UUID column instead of string matching
- Validates client exists before querying
- Returns 404 for unknown clients

---

### 2. segmentation-events/route.ts ✅

**Before:**
```typescript
.eq('client_name', clientName)
```

**After:**
```typescript
import { resolveClientUUID } from '@/lib/client-resolver'
// ... resolves client_name to UUID
.eq('client_uuid', clientUUID)
```

**Benefits:**
- Consistent with other APIs
- Leverages client alias resolution
- Improved query performance

---

### 3. chasen/recommend-actions/route.ts ✅

**Before:**
```typescript
async function gatherClientContext(clientName: string) {
  // All queries used ilike('client_name', clientName)
}
```

**After:**
```typescript
async function gatherClientContext(clientName: string, clientUUID?: string) {
  // Uses client_uuid for tables that support it:
  // - clients (by id)
  // - actions (by client_uuid)
  // - segmentation_events (by client_uuid)
  // - portfolio_initiatives (by client_id)
  // - nps_responses (by client_uuid)
  // - unified_meetings (by client_uuid)

  // Falls back to client_name for views without client_uuid:
  // - event_compliance_by_type
  // - client_compliance_predictions
  // - aging_accounts_compliance
}
```

**Benefits:**
- 6 tables now use indexed UUID lookups
- 3 views still use client_name (can't add UUID to views)
- Backwards compatible with fallback to name matching

---

### 4. cron/aged-accounts-snapshot/route.ts ✅ (No Changes Needed)

This route inserts records with `client_name` into `aged_accounts_history`. The database trigger automatically populates `client_uuid` from the alias resolution function.

**How it works:**
1. Route inserts `{ client_name: 'Client Name', ... }`
2. Database trigger `auto_populate_client_uuid_on_insert` fires
3. Trigger calls `resolve_client_id(NEW.client_name)`
4. `client_uuid` is auto-populated

---

## Files Already Using client_uuid

The following API routes were already updated in previous sessions:

| File | Status |
|------|--------|
| chasen/meeting-prep/route.ts | ✅ Uses client_uuid |
| chasen/nps-insights/route.ts | ✅ Uses client_uuid |
| clients/health-insights/route.ts | ✅ Uses client_uuid |
| clients/health-history/route.ts | ✅ Uses resolveClientUUID |

---

## Tables with client_uuid

After all Priority 1-3 optimisations, these tables have `client_uuid`:

| Table | Has client_uuid | Has Trigger |
|-------|-----------------|-------------|
| clients | ✅ (id) | N/A |
| nps_responses | ✅ | ✅ |
| unified_meetings | ✅ | ✅ |
| actions | ✅ | ✅ |
| segmentation_events | ✅ | ✅ |
| aged_accounts_history | ✅ | ✅ |
| client_event_exclusions | ✅ | ✅ |
| client_logos | ✅ | ✅ |
| comments | ✅ | ✅ |
| cse_client_assignments | ✅ | ✅ |
| nps_client_priority | ✅ | ✅ |
| nps_client_trends | ✅ | ✅ |
| portfolio_initiatives | ✅ (client_id) | N/A |

---

## Tables Still Using client_name

These tables/views don't have `client_uuid` yet:

| Table/View | Reason |
|------------|--------|
| event_compliance_by_type | Materialised view |
| client_compliance_predictions | Analysis table |
| aging_accounts_compliance | Materialised view |
| chasen_documents | Document storage |
| chasen_folders | Folder organisation |
| chasen_recommendations | AI cache |
| nps_insights_cache | NPS cache |
| client_health_summary | View |
| client_health_history | History table |

---

## Build Verification

```
✓ Compiled successfully in 7.5s
✓ Generating static pages using 13 workers (101/101) in 601.1ms
```

All 101 pages generated successfully with no TypeScript errors.

---

## Performance Benefits

1. **UUID lookups are faster**: B-tree index on UUID vs text comparison
2. **Consistent client resolution**: All queries go through unified alias system
3. **Better error handling**: Unknown clients return 404 instead of empty results
4. **Reduced case sensitivity issues**: UUID is exact match, no ilike needed

---

*Report generated by Claude Code on 2025-12-27*
