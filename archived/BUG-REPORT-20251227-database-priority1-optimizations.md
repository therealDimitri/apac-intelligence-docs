# Bug Report: Database Priority 1 Optimizations

**Date:** 2025-12-27
**Status:** RESOLVED
**Priority:** Medium
**Category:** Database Optimisation

---

## Summary

Applied Priority 1 database optimizations identified in the DATABASE-OPTIMISATION-REPORT-20251227.md, including removal of test/duplicate tables, deprecation comments on legacy tables, and RLS policies on unprotected tables.

---

## Issues Identified

### 1. Test Data Tables in Production
- `test_meetings` table (10 rows) - Test data should not exist in production

### 2. Duplicate Tables
- `aging_accounts_history` (0 rows) - Empty duplicate of `aged_accounts_history` (427 rows)

### 3. Legacy Tables Without Deprecation Notices
- `client_name_aliases` - Superseded by `client_aliases_unified`
- `nps_clients` - Superseded by `clients` table

### 4. Tables Without RLS Policies
- `document_embeddings` (250 rows) - Medium security risk
- `chasen_user_memories` (5 rows) - Contains user-specific data

---

## Fixes Applied

### 1. Removed Test/Duplicate Tables
```sql
DROP TABLE IF EXISTS test_meetings CASCADE;
DROP TABLE IF EXISTS aging_accounts_history CASCADE;
```

### 2. Added Deprecation Comments
```sql
COMMENT ON TABLE client_name_aliases IS 'DEPRECATED: Use client_aliases_unified instead. This table will be removed in a future release.';
COMMENT ON TABLE nps_clients IS 'DEPRECATED: Use clients table instead. Foreign keys still reference this table - migration in progress.';
```

### 3. Added RLS to document_embeddings
```sql
ALTER TABLE document_embeddings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Service role has full access to document_embeddings"
ON document_embeddings FOR ALL TO service_role
USING (true) WITH CHECK (true);

CREATE POLICY "Authenticated users can read document_embeddings"
ON document_embeddings FOR SELECT TO authenticated
USING (true);
```

### 4. Added RLS to chasen_user_memories
```sql
ALTER TABLE chasen_user_memories ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Service role has full access to chasen_user_memories"
ON chasen_user_memories FOR ALL TO service_role
USING (true) WITH CHECK (true);

CREATE POLICY "Users can manage their own memories"
ON chasen_user_memories FOR ALL TO authenticated
USING (user_email = (auth.jwt() ->> 'email'))
WITH CHECK (user_email = (auth.jwt() ->> 'email'));
```

---

## Issues Encountered During Fix

### 1. exec_sql Parameter Name
- **Issue:** Initial script used wrong parameter name `sql` instead of `sql_query`
- **Fix:** Updated to use correct parameter: `supabase.rpc('exec_sql', { sql_query: sql })`

### 2. chasen_user_memories Column Name
- **Issue:** Initial RLS policy referenced non-existent `user_id` column
- **Fix:** Updated policy to use actual column name `user_email`

---

## Verification

| Change | Status |
|--------|--------|
| test_meetings dropped | ✅ Verified |
| aging_accounts_history dropped | ✅ Verified |
| client_name_aliases deprecated | ✅ Applied |
| nps_clients deprecated | ✅ Applied |
| document_embeddings RLS | ✅ Enabled with 2 policies |
| chasen_user_memories RLS | ✅ Enabled with 2 policies |

---

## Database State After Optimizations

| Metric | Before | After |
|--------|--------|-------|
| Total tables | 89 | 87 |
| Empty tables | 24 | 22 |
| Tables without RLS | 5 | 3 |
| Duplicate tables | 1 | 0 |
| Test tables | 1 | 0 |

---

## Remaining Work (Priority 2-3)

### Priority 2 (Next 2 Weeks)
1. Add `client_uuid` to remaining 23 tables
2. Consolidate `client_meetings` into `unified_meetings`
3. Migrate FK references from `nps_clients` to `clients`

### Priority 3 (Next Month)
1. Normalise `unified_meetings` (54 columns)
2. Consolidate RLS policies on `actions` table (15 → 5)
3. Archive old data from history tables

---

## Files Modified

- `scripts/apply-priority1-optimizations.mjs` - Migration script

---

## Related Documentation

- `docs/DATABASE-OPTIMISATION-REPORT-20251227.md` - Full audit report
- `docs/DIAGNOSTIC-20251227-client-unification-adoption.md` - Client unification status
- `backups/supabase-20251227-141416/` - Pre-optimization backup

---

*Report generated by Claude Code on 2025-12-27*
