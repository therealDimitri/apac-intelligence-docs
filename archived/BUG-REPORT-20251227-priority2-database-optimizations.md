# Bug Report: Priority 2 Database Optimizations

**Date:** 2025-12-27
**Status:** PARTIALLY RESOLVED
**Priority:** Medium
**Category:** Database Optimisation

---

## Summary

Applied Priority 2 database optimizations including adding `client_uuid` to remaining tables and documenting table consolidation/FK migration for future work.

---

## Completed Work

### 1. Added `client_uuid` to 8 Tables

| Table | Coverage | Status |
|-------|----------|--------|
| aged_accounts_history | 397/427 (93%) | ✅ |
| client_event_exclusions | 41/41 (100%) | ✅ |
| client_logos | 19/19 (100%) | ✅ |
| client_meetings | 41/41 (100%) | ✅ |
| comments | 11/12 (92%) | ✅ |
| cse_client_assignments | 25/25 (100%) | ✅ |
| nps_client_priority | 11/13 (85%) | ⚠️ |
| nps_client_trends | 16/18 (89%) | ⚠️ |

### 2. Added New Client

- **Strategic Asia Pacific Partners (SAPP)** - Added as new client with aliases

### 3. Added 25+ New Aliases for Internal Client

Including:
- Internal Meeting
- Team Management
- Test Client
- NPS Client Success Session variations
- Various internal meeting names

### 4. Marked Tables as Deprecated

- `client_meetings` - DEPRECATED: Contains 34/41 duplicates with `unified_meetings`

---

## Overall client_uuid Coverage

| Table | Coverage | Status |
|-------|----------|--------|
| aged_accounts_history | 93% | ✅ |
| client_event_exclusions | 100% | ✅ |
| client_logos | 100% | ✅ |
| client_meetings | 100% | ✅ |
| comments | 92% | ✅ |
| cse_client_assignments | 100% | ✅ |
| nps_client_priority | 85% | ⚠️ |
| nps_client_trends | 89% | ⚠️ |
| unified_meetings | 73% | ⚠️ |
| actions | 88% | ⚠️ |
| nps_responses | 100% | ✅ |
| client_segmentation | 100% | ✅ |
| aging_accounts | 100% | ✅ |
| **TOTAL** | **92%** | ✅ |

---

## Deferred Work

### 1. client_meetings Consolidation

**Status:** Documented for future work

**Analysis:**
- 34/41 entries are duplicates of `unified_meetings`
- 7 unique entries would need migration
- Risk of breaking existing code that references `client_meetings`

**Recommendation:** Use `unified_meetings` for all new code. Eventually migrate 7 unique entries and drop table.

### 2. nps_clients FK Migration

**Status:** Documented for future work

**Current FK References to nps_clients:**
| Table | Column | Constraint |
|-------|--------|------------|
| actions | client_id | fk_actions_client |
| aging_accounts | client_id | fk_aging_accounts_client |
| nps_responses | client_id | fk_nps_responses_client |
| segmentation_events | client_id | segmentation_events_client_id_fkey |
| unified_meetings | client_id | fk_unified_meetings_client |

**Recommendation:**
1. Use `client_uuid` column (already populated) for new queries
2. Keep INTEGER `client_id` for backward compatibility
3. Eventually drop FK constraints and `client_id` columns when app code fully migrated

---

## Scripts Created

| Script | Purpose |
|--------|---------|
| `apply-client-uuid-to-remaining-tables.mjs` | Add client_uuid to 8 tables |
| `add-internal-aliases.mjs` | Add aliases for Internal client |
| `report-client-uuid-coverage.mjs` | Generate coverage report |

---

## Next Steps (Priority 3)

1. Normalise `unified_meetings` (54 columns → multiple tables)
2. Consolidate RLS policies on `actions` (15 → 5)
3. Complete FK migration from `nps_clients` to `clients`
4. Archive old data from history tables

---

*Report generated by Claude Code on 2025-12-27*
