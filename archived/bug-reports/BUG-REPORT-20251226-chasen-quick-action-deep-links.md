# Bug Report: ChaSen Quick Action Deep Links Not Opening Modals

**Date**: 26 December 2025
**Severity**: Medium
**Status**: Fixed
**Commit**: `df63dc7`

---

## Summary

Quick Action buttons from ChaSen crews ("Create Action", "Schedule Meeting") were navigating to pages but not opening the respective modals. Users had to manually click the "New" button after landing on the page.

## Root Cause

The deep link handlers in the actions and meetings pages only handled specific ID lookups:

- Actions: `?action=<id>` opened a specific action by ID
- Meetings: `?meeting=<id>` opened a specific meeting by ID

The URL patterns `?action=create&client=X` and `?action=schedule&client=X` generated by ChaSen's Quick Actions were not handled, so the modals never opened.

## Affected Components

| Component               | Issue                             |
| ----------------------- | --------------------------------- |
| `actions/page.tsx`      | No handler for `?action=create`   |
| `meetings/page.tsx`     | No handler for `?action=schedule` |
| `CreateActionModal.tsx` | No `defaultClient` prop           |

## Fix Applied

### 1. Added `defaultClient` Prop to CreateActionModal

```typescript
interface CreateActionModalProps {
  isOpen: boolean
  onClose: () => void
  onSuccess: () => void
  defaultClient?: string // NEW
}

// Auto-fill client when modal opens
useEffect(() => {
  if (isOpen && defaultClient && formData.clients.length === 0) {
    setFormData(prev => ({
      ...prev,
      clients: [defaultClient],
    }))
  }
}, [isOpen, defaultClient])
```

### 2. Updated Actions Page Deep Link Handler

```typescript
// Before: Only handled action IDs
const actionIdParam = searchParams.get('action')
if (actionIdParam && actions.find(a => a.id === actionIdParam)) { ... }

// After: Handles both create and ID lookup
if (actionParam === 'create') {
  setCreateActionClient(clientParam || undefined)
  setCreatingAction(true)
  setDeepLinkHandled(true)
} else if (actionParam && actions.length > 0) {
  // existing ID lookup logic
}
```

### 3. Updated Meetings Page Deep Link Handler

```typescript
// Before: Only handled meeting IDs
const meetingIdParam = searchParams.get('meeting')
if (meetingIdParam && meetings.find(m => m.id === meetingIdParam)) { ... }

// After: Handles both schedule and ID lookup
if (actionParam === 'schedule') {
  setScheduleClient(clientParam || undefined)
  setShowScheduleModal(true)
  setDeepLinkHandled(true)
} else if (meetingIdParam && meetings.length > 0) {
  // existing ID lookup logic
}
```

### 4. Passed Client Context to Modals

```tsx
// Actions page
<CreateActionModal
  isOpen={creatingAction}
  onClose={() => {
    setCreatingAction(false)
    setCreateActionClient(undefined)
  }}
  defaultClient={createActionClient}
/>

// Meetings page
<AIFirstMeetingModal
  isOpen={showScheduleModal}
  onClose={() => {
    setShowScheduleModal(false)
    setScheduleClient(undefined)
  }}
  contextClientName={scheduleClient}
/>
```

## Files Changed

| File                                    | Change                                                 |
| --------------------------------------- | ------------------------------------------------------ |
| `src/components/CreateActionModal.tsx`  | Added `defaultClient` prop and useEffect               |
| `src/app/(dashboard)/actions/page.tsx`  | Added `createActionClient` state and deep link handler |
| `src/app/(dashboard)/meetings/page.tsx` | Added `scheduleClient` state and deep link handler     |
| `src/app/api/chasen/crew/route.ts`      | Fixed segment, NPS, and heading format (related fixes) |

## Testing

1. Open ChaSen AI (`Cmd+K` or navigate to `/ai`)
2. Select "Client Report" or "Meeting Prep" crew
3. Enter a client name (e.g., "GHA")
4. Verify Quick Actions work:
   - [ ] "Create Action" opens CreateActionModal with client pre-filled
   - [ ] "Schedule Meeting" opens AIFirstMeetingModal with client context
   - [ ] "View Profile" navigates to client detail page
   - [ ] "View Actions" navigates to actions page with client filter
   - [ ] "View Meetings" navigates to meetings page
   - [ ] "View NPS" navigates to NPS page with client filter

## URL Patterns

| Action             | URL Pattern                            | Behaviour                              |
| ------------------ | -------------------------------------- | -------------------------------------- |
| Create Action      | `/actions?action=create&client=GHA`    | Opens create modal with GHA pre-filled |
| Schedule Meeting   | `/meetings?action=schedule&client=GHA` | Opens schedule modal with GHA context  |
| View Action by ID  | `/actions?action=ACT-001`              | Opens specific action detail           |
| View Meeting by ID | `/meetings?meeting=MTG-001`            | Selects specific meeting               |

## Prevention

This reinforces the importance of:

1. Testing all click handlers end-to-end, not just URL generation
2. Documenting expected URL patterns and their handlers
3. Ensuring modals can accept pre-filled data from deep links
