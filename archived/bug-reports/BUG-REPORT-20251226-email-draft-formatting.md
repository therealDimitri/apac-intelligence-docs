# Bug Report: ChaSen Email Draft Formatting Not Outlook-Ready

**Date:** 26 December 2025
**Status:** Resolved
**Severity:** Medium
**Component:** ChaSen AI - Email Draft Generation & Markdown Rendering

---

## Summary

Email drafts generated by ChaSen AI were not formatted correctly for professional use in Outlook. The markdown rendering was applying dashboard-style formatting to email content, making the output unprofessional and inconsistent.

---

## Symptoms

1. **`\***` rendered as raw text\*\* - Horizontal rule markers were displayed as literal asterisks instead of being converted to visual separators
2. **Salutation styled as H2 heading** - "Dear [Executive Sponsor Name]," was rendered with large heading styling and gradient underline
3. **Sign-off styled as headings** - "Best regards," and the sender's name were rendered as headings
4. **Unprofessional appearance** - The email looked like a dashboard report rather than a professional business email

---

## Root Cause

Two issues contributed to this bug:

### 1. Missing Horizontal Rule Handling in Markdown Renderer

The `renderMarkdownContent()` function in `src/app/(dashboard)/ai/page.tsx` had no handling for horizontal rule markers (`---`, `***`, `___`). These were falling through to the default paragraph rendering, causing them to appear as raw text.

### 2. No Email-Specific Formatting Guidelines in System Prompt

The ChaSen system prompt in `src/app/api/chasen/stream/route.ts` provided structured response formats for analysis queries but had no specific guidance for email drafts. The LLM was applying the same markdown formatting (using `##` headers) to email content, which was inappropriate.

---

## Files Modified

### 1. `src/app/(dashboard)/ai/page.tsx`

**Change:** Added horizontal rule handling to `renderMarkdownContent()` function.

```typescript
// Horizontal rules (---, ***, ___) - subtle separator
if (trimmedLine === '---' || trimmedLine === '***' || trimmedLine === '___') {
  elements.push(
    <hr key={i} className="my-4 border-t border-gray-200" />
  )
  i++
  continue
}
```

**Location:** Lines 370-377 (before H2 header handling)

### 2. `src/app/api/chasen/stream/route.ts`

**Change:** Added comprehensive email draft formatting guidelines to the system prompt.

```
## EMAIL DRAFT FORMATTING

When asked to draft an email, follow these rules for Outlook-ready formatting:

**DO NOT use markdown headers (##, ###) for email content.** Headers are for dashboard reports, not emails.

**Correct email format:**
Dear [Recipient Name],

[Opening paragraph - context and purpose]

[Body paragraphs with key points. Use plain bullet lists if needed:]
- Point one
- Point two

[Closing paragraph - call to action or next steps]

Best regards,
[User's name]
[Title if applicable]

**DO:**
- Use plain text salutations (Dear, Hi, Hello)
- Use simple paragraph breaks for readability
- Use plain bullet points (-) for lists if needed
- Keep the signature simple: name on its own line

**DO NOT:**
- Use ## or ### before salutation or sign-off
- Use *** or --- separators within email body
- Add emoji to email content (keep it professional)
- Include "Explore Further" sections in emails
```

**Location:** Lines 800-833 (after FOLLOW-UP QUESTIONS section, before DATA GUIDELINES)

---

## Testing Performed

1. Started dev server on port 3002
2. Navigated to ChaSen AI page (`/ai`)
3. Sent message: "Draft an email to the executive sponsor at SA Health about their current NPS score and our improvement plan"
4. Verified response:
   - Salutation "Dear [Executive Sponsor Name]," rendered as plain paragraph
   - Body paragraphs rendered without heading styling
   - Horizontal rule rendered as `<hr>` separator element
   - Sign-off "Best regards," and sender name rendered as plain paragraphs
5. TypeScript check passed (`npx tsc --noEmit`)

---

## Before/After Comparison

### Before (Broken)

- `***` displayed as literal text
- "Dear [Name]," styled as large H2 with gradient underline
- "Best regards," styled as heading
- Sender name styled as heading

### After (Fixed)

- Horizontal rules render as subtle `<hr>` separators
- Salutation renders as plain paragraph text
- Sign-off renders as plain paragraph text
- Professional, Outlook-ready email appearance

---

## Prevention

This issue occurred because:

1. The markdown renderer was incomplete (missing horizontal rule support)
2. The LLM prompt didn't differentiate between report and email content

To prevent similar issues:

1. When adding new content types to ChaSen, add specific formatting guidelines to the system prompt
2. Ensure the markdown renderer supports all standard markdown elements
3. Test different content types (emails, reports, summaries) when making rendering changes

---

## Related Files

- `src/app/(dashboard)/ai/page.tsx` - Markdown rendering function
- `src/app/api/chasen/stream/route.ts` - ChaSen system prompt and response generation
- `docs/BUG-REPORT-20251226-kanban-density-toggle.md` - Related fix from same session
