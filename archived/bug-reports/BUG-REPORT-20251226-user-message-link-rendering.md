# Bug Report: ChaSen User Message Markdown Links Not Rendering

**Date:** 26 December 2025
**Status:** Resolved
**Severity:** Low
**Component:** ChaSen AI - User Message Display

---

## Summary

Markdown links in user messages were displayed as raw text instead of being rendered as clickable links. When users clicked follow-up questions containing markdown links (e.g., `[SingHealth](/clients/SingHealth/v2)`), the raw markdown syntax was shown in the user's message bubble.

---

## Symptoms

1. User message bubble showed raw markdown: `[SingHealth](/clients/SingHealth/v2)`
2. The bracket and parenthesis syntax was visible instead of a clickable link
3. Follow-up questions generated by ChaSen with client links displayed incorrectly when clicked

---

## Root Cause

The user message rendering in `src/app/(dashboard)/ai/page.tsx` used plain text rendering without any markdown processing:

```tsx
// Line 3217 (before fix)
<p className="text-[15px] leading-relaxed">{chat.message}</p>
```

While assistant messages were processed through `renderMarkdownContent()`, user messages were rendered as-is without link conversion.

---

## Files Modified

### `src/app/(dashboard)/ai/page.tsx`

**Change 1:** Added new function `renderUserMessageWithLinks()` (lines 169-212)

```typescript
function renderUserMessageWithLinks(text: string): React.ReactNode {
  // Match markdown links [text](url) - handles URLs with parentheses
  const linkRegex = /\[([^\]]+)\]\(((?:[^()]|\([^)]*\))+)\)/g
  const parts: React.ReactNode[] = []
  let lastIndex = 0
  let match

  while ((match = linkRegex.exec(text)) !== null) {
    // Add text before the link
    if (match.index > lastIndex) {
      parts.push(text.slice(lastIndex, match.index))
    }

    const linkText = match[1]
    const url = match[2]
    const isInternal = url.startsWith('/') && !url.startsWith('//')

    parts.push(
      <a
        key={match.index}
        href={url}
        target={isInternal ? undefined : '_blank'}
        rel={isInternal ? undefined : 'noopener noreferrer'}
        className="underline decoration-white/50 hover:decoration-white transition-colors"
      >
        {linkText}
      </a>
    )

    lastIndex = match.index + match[0].length
  }

  // Add any remaining text
  if (lastIndex < text.length) {
    parts.push(text.slice(lastIndex))
  }

  return parts.length > 0 ? parts : text
}
```

**Change 2:** Updated user message rendering to use the new function (line 3217-3219)

```tsx
// Before
<p className="text-[15px] leading-relaxed">{chat.message}</p>

// After
<p className="text-[15px] leading-relaxed">
  {renderUserMessageWithLinks(chat.message)}
</p>
```

---

## Testing Performed

1. Navigated to ChaSen AI page (`/ai`)
2. Typed message with markdown link: `Tell me about [SingHealth](/clients/SingHealth/v2) and their recent actions`
3. Verified the user message bubble displays "SingHealth" as a clickable underlined link
4. Verified the link points to `/clients/SingHealth/v2`
5. TypeScript check passed (`npx tsc --noEmit`)

---

## Before/After Comparison

### Before (Broken)

- User message showed: `Tell me about [SingHealth](/clients/SingHealth/v2) and their recent actions`
- Raw markdown syntax visible
- Not clickable

### After (Fixed)

- User message shows: `Tell me about SingHealth and their recent actions`
- "SingHealth" is an underlined clickable link
- Clicking navigates to client profile page

---

## Design Decisions

1. **Underline styling** - Links use `underline decoration-white/50 hover:decoration-white` to be visible against the purple user message background
2. **Internal vs External** - Internal links (starting with `/`) don't open in new tab; external links open in new tab with `noopener noreferrer`
3. **Minimal processing** - Only markdown links are processed, not full markdown (no bold, italic, headers) to keep user messages simple

---

## Related Files

- `src/app/(dashboard)/ai/page.tsx` - Main ChaSen AI page with message rendering
- `docs/BUG-REPORT-20251226-email-draft-formatting.md` - Related fix from same session
