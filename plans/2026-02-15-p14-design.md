# P14 Design: Performance, E2E, ChaSen, BURC Tables, Mobile UX

**Date:** 2026-02-15
**Status:** Approved
**Approach:** Sequential phases (each builds on the previous)

## Executive Summary

P14 covers 5 workstreams in sequential order:

1. **BURC Missing Tables** — Create 4 monthly financial tables + sync scripts
2. **Performance CI Pipeline** — Lighthouse CI, bundle budgets, Core Web Vitals
3. **ChaSen AI Full Overhaul** — Local inference, context improvements, tool modularisation, prompt DB, new capabilities
4. **E2E Test Expansion** — 7 new workflow tests + API contracts + mutation verification
5. **Mobile UX Audit + Fixes** — Systematic audit, then fix what's found

## Phase 1: BURC Missing Tables

### Tables to Create

| Table | Source Rows | Purpose |
|-------|------------|---------|
| `burc_opex_monthly` | APAC BURC rows 71-98 | OPEX by department (PS, Sales, R&D, G&A, Maint) per month |
| `burc_cogs_monthly` | APAC BURC rows 38-56 | COGS breakdown (PS COGS, HW COGS, SW COGS) per month |
| `burc_net_revenue_monthly` | APAC BURC rows 58-66 | Net revenue by type (SW, PS, Maint, HW) per month |
| `burc_gross_revenue_monthly` | APAC BURC detail rows | Gross revenue by type per month |

### Schema Pattern

Mirror existing `burc_ebita_monthly` structure:

- `id` (UUID, PK)
- `fiscal_year` (text)
- `month` (text)
- `category` (text) — department/type label
- `actual` (numeric)
- `plan` (numeric)
- `variance` (numeric, computed)
- `source_row` (integer) — for debugging row-shift issues
- `created_at`, `updated_at` (timestamptz)

### Sync Approach

- Extend `sync-burc-all-worksheets.mjs` with 4 new parser functions
- Use existing row-map pattern from `burc-sync.md`
- Add row-label validation: read column A, match expected label before parsing values (detect Finance restructures)
- RLS: anon read, service role write (same as existing BURC tables)

### Deliverables

- 1 migration (all 4 tables + RLS policies)
- 4 parser functions in sync script
- ChaSen formatter entries for all 4 tables in `chasen-dynamic-context.ts`
- Dashboard drill-down components for OPEX/COGS/revenue breakdowns

---

## Phase 2: Performance CI Pipeline

### Bundle Analyzer Integration

Wire up already-installed `@next/bundle-analyzer` in `next.config.ts` behind `ANALYZE=true` env var. Add `npm run analyze` script.

### Lighthouse CI Config

`.lighthouserc.js` thresholds:

| Metric | Threshold |
|--------|-----------|
| Performance | >= 80 |
| Accessibility | >= 95 |
| Best Practices | >= 90 |
| SEO | >= 80 |
| LCP | < 2.5s |
| FID | < 100ms |
| CLS | < 0.1 |

### GitHub Actions Workflow

`.github/workflows/perf.yml`:

- **Trigger:** push to `main`, PR to `main`
- **Steps:** build -> start server -> run Lighthouse CI -> upload report -> comment on PR with results
- **Bundle size check:** compare `next build` output stats against stored baseline, fail if JS bundle grows >5%

### Baseline Audit

Run Lighthouse once on current prod, document baselines, fix low-hanging issues.

---

## Phase 3: ChaSen AI Full Overhaul

### 3A. Land Stashed Transformers.js Work

- Apply stash (`stash@{0}`: local HuggingFace Transformers.js inference)
- Create missing `src/lib/local-inference.ts` and `src/lib/local-inference-nps.ts`
- Implement fallback chain: Local Transformers -> Anthropic API -> keyword fallback
- Add `ENABLE_LOCAL_INFERENCE=true` env var toggle
- Test: batch classify 100 NPS comments, validate accuracy >= 90% vs API baseline
- Stash changes: +38 lines across .gitignore, next.config.ts, package.json, topic-extraction.ts

### 3B. Context System Improvements

- **Formatter Registry**: Extract 600-line if/else in `chasen-dynamic-context.ts` into `Map<tableName, FormatterFn>` registry. Each formatter is a pure function. New BURC tables get entries automatically.
- **Context Window Budgeting**: Add `max_tokens` column to `chasen_data_sources` table. Summarise/truncate sources exceeding budget. Total data context budget: 8K tokens.
- **Tiered Timeout Fallback**: Replace 2.5s blanket timeout with priority ranking: graph RAG (highest) -> dynamic context -> memory. If total >4s, use whatever is available.

### 3C. Tool System Modularisation

Split `chasen-tools.ts` (1,682 lines) into:

- `chasen-tool-registry.ts` — tool definitions + metadata
- `chasen-tool-executors/` directory — one file per category (read, write, workflow, goals)
- `chasen-tool-resolver.ts` — maps intent -> required tools

New table: `chasen_tool_executions` (tool_name, params, result_summary, duration_ms, user_id, created_at)

### 3D. Prompt System

- New table: `chasen_prompts` (page, prompt_text, category, relevance_score, click_count, enabled)
- Move 150+ hardcoded prompts via seed migration
- Click-through boosting computed in DB (replaces localStorage)
- Admin UI: `/settings/chasen/prompts` — enable/disable, edit text, view click stats

### 3E. New Capabilities

- **Proactive Insights**: Daily scheduled function identifies anomalies (health drops, overdue actions, NPS decline) -> queues `chasen_notifications` for display on next login
- **Planning Integration**: ChaSen reads active account plans and suggests next steps based on plan status + client data
- **Model Fallback Chains**: Gemini Flash fails -> Claude Sonnet -> GPT-4O (currently errors propagate)

---

## Phase 4: E2E Test Expansion

### New Workflow Tests (Breadth)

| Flow | Test File | Key Assertions |
|------|-----------|----------------|
| Planning Wizard | `planning-wizard.spec.ts` | Create plan -> 6 steps -> AI suggestions -> save draft -> approve |
| Pipeline Bookings | `pipeline.spec.ts` | Load table -> filter -> sort -> inline edit -> export |
| NPS Analytics | `nps-analytics.spec.ts` | Dashboard loads -> themes render -> filter by score -> drill to respondent |
| Compliance | `compliance.spec.ts` | Tier requirements -> log event -> score updates -> snapshot history |
| Briefing Room | `briefing-room.spec.ts` | Meeting list -> filter -> detail -> notes editor -> follow-up action |
| Actions Kanban | `actions-kanban.spec.ts` | 4 columns render -> drag card -> status updates -> bulk select -> bulk update |
| BURC Renewals | `burc-renewals.spec.ts` | Calendar view -> list view -> RAG status -> filter by risk |

### API Contract Tests (Depth)

`api-contracts.spec.ts` — validate 10 critical API routes:

- `/api/clients`, `/api/actions`, `/api/meetings`, `/api/nps`, `/api/planning`
- `/api/chasen/stream`, `/api/pipeline`, `/api/segmentation-events`
- `/api/support-metrics/trends`, `/api/burc/financials`

Validate: status codes, response structure (`{ success, data }`), error formats.

### Data Mutation Verification

Each workflow test that creates/updates data queries Supabase directly to confirm persistence (not just UI state).

---

## Phase 5: Mobile UX Audit + Fixes

### Audit Phase

Systematic audit using Playwright mobile device profiles (iPhone 12, iPhone SE, Pixel 7):

**Automated checks** (extend `mobile-responsive.spec.ts`):
- Touch target sizes (minimum 44x44px per WCAG 2.5.5)
- Horizontal overflow on every page
- Text legibility (minimum 16px body)
- Interactive element spacing (minimum 8px between tap targets)

**Manual review** (screenshots per page per device):
- Data tables on narrow screens
- Form layouts and input types
- Navigation flow and tap count
- Modal/drawer sizing
- ChaSen AI on mobile

**Output:** `docs/plans/mobile-ux-audit-results.md` with scores per page and prioritised fix list.

### Fix Phase

Based on audit findings. Expected areas:
- Touch target increases on secondary actions
- Data table mobile cards for horizontal-scroll-only tables
- Form input type attributes (`inputmode="numeric"`, `type="email"`)
- Safe area insets for iOS notch/Dynamic Island
- Bottom sheet height management

### Success Criteria

Mobile UX score 10/10 (audited, not estimated).

---

## Dependencies

```
Phase 1 (BURC tables) -> Phase 3B (ChaSen formatter entries for new tables)
Phase 2 (Perf CI) -> Phase 3A (validates Transformers.js doesn't blow bundle budget)
Phase 3 (ChaSen) -> Phase 4 (E2E tests cover ChaSen capabilities)
Phase 4 (E2E) -> Phase 5 (mobile tests catch mobile regressions)
```

## Scope Summary

| Phase | Estimated Files | New Tables | New Tests |
|-------|----------------|------------|-----------|
| 1. BURC Tables | ~8 | 4 | 0 |
| 2. Performance CI | ~5 | 0 | 0 |
| 3. ChaSen Overhaul | ~25 | 3 | Unit tests |
| 4. E2E Expansion | ~9 | 0 | ~9 test files |
| 5. Mobile UX | TBD (audit) | 0 | Extended mobile tests |
